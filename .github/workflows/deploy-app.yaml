name: Deploy

on:
  workflow_dispatch:
    inputs:
      tags:
        description: "Deploy tag (e.g. 1.2.3)"
        required: true
        type: string
      build:
        description: "Build for envirinment"
        required: true
        default: stg
        type: choice
        options:
          # - dev
          - stg
          - prd

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Get tag version
        id: tag
        run: |
          tag=${{ github.event.inputs.tags }}
          echo "$tag"

          if [[ $tag =~ ^v?([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "version=v${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "Input tag ($tag) is not Semantic Versioning format. (e.g. 1.2.3)"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: show log
        run: |
          version=${{ steps.tag.outputs.version }}
          build=${{ github.event.inputs.build }}
          count=$(git tag -l "$version-$build.[0-9]" | grep -c ".")
          num=$(expr $count + 1)
          echo 'next deploy tag is' "$version-$build.$num"
          echo 'deploy count is' $count
          echo 'branch name is' ${{ github.ref_name }}
          git rev-list --count $version..HEAD
      # - name: Tagging
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       github.rest.git.createTag({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         tag: ${{ github.event.inputs.tags }},
      #         message: ${{ github.event.inputs.tags }},
      #         object: ${{ github.sha }},
      #         type: 'commit',
      #       });
